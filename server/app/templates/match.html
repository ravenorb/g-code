<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sample Library</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f8fafc;
        color: #0f172a;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.75rem;
      }
      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background: #f1f5f9;
      }
      .hidden {
        display: none;
      }
      .top-link {
        display: inline-block;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>Sample Library</h1>
    <a class="top-link" href="/">Back to Uploaded MPF Index</a>
    <div class="card">
      <p id="samples-status">Loading sample matches...</p>
      <table id="samples-table" class="hidden">
        <thead>
          <tr>
            <th>MPF File</th>
            <th>PDF Match</th>
            <th>Score</th>
            <th>Sheet</th>
            <th>Parts</th>
            <th>Diagnostics</th>
            <th>Pair Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const samplesStatus = document.getElementById("samples-status");
      const samplesTable = document.getElementById("samples-table");
      const samplesBody = samplesTable.querySelector("tbody");

      function getPairText(item) {
        if (!item || !item.best_match) {
          return "No match";
        }
        const reasons = Array.isArray(item.best_match.reasons) ? item.best_match.reasons.join(", ") : "";
        return `${item.best_match.pdf}${reasons ? ` (${reasons})` : ""}`;
      }

      async function loadSampleMatches() {
        try {
          const response = await fetch("/samples");
          if (!response.ok) {
            throw new Error("Unable to load sample library");
          }
          const payload = await response.json();
          const entries = Array.isArray(payload.samples) ? payload.samples : [];

          samplesBody.innerHTML = "";
          if (!entries.length) {
            samplesStatus.textContent = "No sample entries found.";
            return;
          }

          entries.forEach((item) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${item.mpf_filename || ""}</td>
              <td>${item.pdf_match || ""}</td>
              <td>${item.match_score ?? ""}</td>
              <td>${item.sheet || ""}</td>
              <td>${item.part_count ?? ""}</td>
              <td>${item.diagnostic_count ?? ""}</td>
              <td>${getPairText(item)}</td>
            `;
            samplesBody.appendChild(tr);
          });

          samplesTable.classList.remove("hidden");
          samplesStatus.textContent = `Loaded ${entries.length} sample row(s).`;
        } catch (error) {
          samplesStatus.textContent = `Error: ${error.message}`;
        }
      }

      loadSampleMatches();
    </script>
  </body>
</html>
