<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HK Parser Upload</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f8fafc;
        color: #0f172a;
      }
      h1,
      h2 {
        margin-bottom: 0.5rem;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
      }
      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background: #f1f5f9;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.35rem;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #fff;
      }
      .badge.error {
        background: #ef4444;
      }
      .badge.warning {
        background: #f59e0b;
      }
      .hidden {
        display: none;
      }
      .sheet-container {
        margin-top: 1rem;
        border: 1px dashed #cbd5e1;
        border-radius: 8px;
        background: #f8fafc;
        padding: 0.5rem;
      }
      .sheet {
        position: relative;
        width: 100%;
        max-width: 720px;
        height: 420px;
        margin: 0 auto;
        background: #e2e8f0;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        overflow: hidden;
      }
      .sheet .part-dot {
        position: absolute;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #0ea5e9;
        color: #0f172a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid #0284c7;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
        transition: transform 120ms ease, background 120ms ease;
      }
      .sheet .part-dot:hover {
        transform: scale(1.05);
        background: #38bdf8;
      }
      .sheet .part-dot.selected {
        background: #22c55e;
        border-color: #15803d;
      }
      .part-detail {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
      }
      .part-detail pre {
        background: #0f172a;
        color: #e2e8f0;
        padding: 0.75rem;
        border-radius: 6px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>HK Parser Upload</h1>
    <div class="card">
      <form id="upload-form">
        <label for="file">Select G-code file:</label>
        <input type="file" id="file" name="file" accept=".gcode,.txt,.mpf,.nc,.tap" required />
        <div style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
          <label for="description">Description:</label><br />
          <textarea id="description" name="description" rows="3" style="width: 100%;" placeholder="Describe the file contents"></textarea>
        </div>
        <button type="submit">Upload & Validate</button>
      </form>
      <p id="status" class="hidden"></p>
    </div>

    <div class="card hidden" id="results-card">
      <h2>Diagnostics</h2>
      <p id="summary"></p>
      <p id="storage"></p>
      <table id="diagnostics-table">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Message</th>
            <th>Line</th>
            <th>Code</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>Parsed Fields</h2>
      <table id="parsed-table">
        <thead>
          <tr>
            <th>Line</th>
            <th>Raw</th>
            <th>Field</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>Sheet Layout</h2>
      <p id="sheet-info" class="hidden"></p>
      <div class="sheet-container">
        <div id="sheet" class="sheet"></div>
      </div>

      <div class="part-detail hidden" id="part-detail"></div>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const statusEl = document.getElementById("status");
      const resultsCard = document.getElementById("results-card");
      const summaryEl = document.getElementById("summary");
      const storageEl = document.getElementById("storage");
      const diagnosticsBody = document.querySelector("#diagnostics-table tbody");
      const parsedBody = document.querySelector("#parsed-table tbody");
      const sheet = document.getElementById("sheet");
      const sheetInfo = document.getElementById("sheet-info");
      const partDetail = document.getElementById("part-detail");
      let lastJobId = null;

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const fileInput = document.getElementById("file");
        if (!fileInput.files.length) return;

        statusEl.classList.remove("hidden");
        statusEl.textContent = "Uploading and validating...";
        resultsCard.classList.add("hidden");
        diagnosticsBody.innerHTML = "";
        parsedBody.innerHTML = "";
        sheet.innerHTML = "";
        sheetInfo.classList.add("hidden");
        partDetail.classList.add("hidden");
        partDetail.innerHTML = "";
        lastJobId = null;

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("description", document.getElementById("description").value);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const detail = await response.text();
            throw new Error(detail || "Validation failed");
          }

          const data = await response.json();
          lastJob = data;
          renderSummary(data);
          renderDiagnostics(data.diagnostics);
          renderParsed(data.parsed_lines);
          renderSheet(data.parts, data.job_id);
          lastJobId = data.job_id;

          statusEl.textContent = "Validation completed.";
          resultsCard.classList.remove("hidden");
        } catch (err) {
          statusEl.textContent = `Error: ${err.message}`;
        }
      });

      function renderSummary(data) {
        summaryEl.textContent = `Job: ${data.job_id} — Errors: ${data.summary.errors}, Warnings: ${data.summary.warnings}, Lines: ${data.summary.lines}`;
      }

      function renderStorage(data) {
        const storageBits = [];
        if (data.stored_path) storageBits.push(`Stored: ${data.stored_path}`);
        if (data.meta_path) storageBits.push(`Meta: ${data.meta_path}`);
        if (data.uploaded_at) storageBits.push(`Uploaded: ${data.uploaded_at}`);
        storageEl.textContent = storageBits.join(" | ");
      }

      function renderDiagnostics(diagnostics) {
        diagnosticsBody.innerHTML = "";
        if (!diagnostics.length) {
          diagnosticsBody.innerHTML = `<tr><td colspan="4">No diagnostics</td></tr>`;
          return;
        }
        diagnostics.forEach((diag) => {
          const row = document.createElement("tr");
          const badge = `<span class="badge ${diag.severity}">${diag.severity}</span>`;
          row.innerHTML = `
            <td>${badge}</td>
            <td>${diag.message}</td>
            <td>${diag.line ?? ""}</td>
            <td>${diag.code ?? ""}</td>
          `;
          diagnosticsBody.appendChild(row);
        });
      }

      function renderParsed(parsedLines) {
        parsedBody.innerHTML = "";
        if (!parsedLines.length) {
          parsedBody.innerHTML = `<tr><td colspan="4">No parsed lines</td></tr>`;
          return;
        }
        parsedLines.forEach((line) => {
          line.fields.forEach((field, idx) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${idx === 0 ? line.line_number : ""}</td>
              <td>${idx === 0 ? line.raw : ""}</td>
              <td>${field.name}</td>
              <td>${field.value}</td>
            `;
            parsedBody.appendChild(row);
          });
        });
      }

      function renderSheet(parts, jobId) {
        sheet.innerHTML = "";
        sheetInfo.classList.add("hidden");
        partDetail.classList.add("hidden");
        partDetail.innerHTML = "";

        if (!parts.length) {
          sheetInfo.textContent = "No parts were detected in this file.";
          sheetInfo.classList.remove("hidden");
          return;
        }

        const withCoords = parts.filter((p) => typeof p.x === "number" && typeof p.y === "number");
        if (!withCoords.length) {
          sheetInfo.textContent = "Parts were detected, but no HKOST coordinates were available to render a layout.";
          sheetInfo.classList.remove("hidden");
          return;
        }

        const xs = withCoords.map((p) => p.x);
        const ys = withCoords.map((p) => p.y);
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);
        const padding = 30;
        const width = sheet.clientWidth || 600;
        const height = sheet.clientHeight || 420;
        const rangeX = maxX - minX || 1;
        const rangeY = maxY - minY || 1;
        const scale = Math.min((width - padding * 2) / rangeX, (height - padding * 2) / rangeY);

        withCoords.forEach((part) => {
          const x = (part.x - minX) * scale + padding;
          const y = (maxY - part.y) * scale + padding;
          const dot = document.createElement("div");
          dot.className = "part-dot";
          dot.textContent = part.hkost_line.toString().slice(-2);
          dot.style.left = `${x}px`;
          dot.style.top = `${y}px`;
          dot.title = `HKOST ${part.hkost_line} @ (${part.x}, ${part.y})`;
          dot.dataset.hkost = part.hkost_line;
          dot.addEventListener("click", () => handlePartClick(dot, jobId, part.hkost_line));
          sheet.appendChild(dot);
        });
      }

      async function handlePartClick(dot, jobId, hkostLine) {
        if (!jobId) return;
        sheet.querySelectorAll(".part-dot").forEach((el) => el.classList.remove("selected"));
        dot.classList.add("selected");
        partDetail.classList.add("hidden");
        partDetail.textContent = "Loading part...";

        try {
          const resp = await fetch(`/jobs/${jobId}/parts/${hkostLine}`);
          if (!resp.ok) {
            throw new Error("Unable to fetch part details");
          }
          const data = await resp.json();
          renderPartDetail(data);
        } catch (err) {
          partDetail.textContent = `Error loading part: ${err.message}`;
          partDetail.classList.remove("hidden");
        }
      }

      function renderPartDetail(part) {
        const heading = document.createElement("h3");
        heading.textContent = `Part HKOST ${part.hkost_line}`;

        const meta = document.createElement("p");
        meta.innerHTML = `
          Profile line: <strong>${part.profile_line ?? "n/a"}</strong> ·
          Contours: <strong>${part.contours}</strong> ·
          Position: <strong>${part.x ?? "?"}</strong>, <strong>${part.y ?? "?"}</strong>
        `;

        const block = document.createElement("pre");
        block.textContent = part.profile_block.join("\\n") || "No profile block available.";

        partDetail.innerHTML = "";
        partDetail.appendChild(heading);
        partDetail.appendChild(meta);
        partDetail.appendChild(block);
        partDetail.classList.remove("hidden");
      }
    </script>
  </body>
</html>
