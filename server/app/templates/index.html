<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HK Parser Upload</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f8fafc;
        color: #0f172a;
      }
      h1,
      h2 {
        margin-bottom: 0.5rem;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
      }
      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background: #f1f5f9;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.35rem;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #fff;
      }
      .badge.error {
        background: #ef4444;
      }
      .badge.warning {
        background: #f59e0b;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>HK Program Uploader</h1>
    <div class="card">
      <form id="upload-form">
        <div>
          <label for="file">Select HK/MPF file:</label>
          <input type="file" id="file" name="file" accept=".mpf,.gcode,.txt" required />
        </div>
        <div style="margin-top: 0.5rem;">
          <label for="description">Description:</label><br />
          <textarea id="description" name="description" rows="2" style="width: 100%;"></textarea>
        </div>
        <button type="submit" style="margin-top: 0.5rem;">Upload</button>
      </form>
      <p id="status" class="hidden"></p>
      <div id="upload-summary" class="hidden"></div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Uploaded Files</h2>
        <button id="refresh">Refresh</button>
      </div>
      <table id="files-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Description</th>
            <th>Parts</th>
            <th>Sheet</th>
            <th>Download</th>
            <th>Extract</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card hidden" id="extract-card">
      <h2>Extract Part</h2>
      <p id="extract-file"></p>
      <label for="part-id">Part ID or index:</label>
      <input id="part-id" type="text" placeholder="10001 or 0" />
      <button id="extract-btn">Extract</button>
      <p id="extract-status"></p>
      <p id="extract-link" class="hidden"></p>
    </div>

    <script>
      const filesTableBody = document.querySelector("#files-table tbody");
      const statusEl = document.getElementById("status");
      const uploadSummary = document.getElementById("upload-summary");
      const extractCard = document.getElementById("extract-card");
      const extractFileEl = document.getElementById("extract-file");
      const extractStatus = document.getElementById("extract-status");
      const extractLink = document.getElementById("extract-link");
      let selectedFileId = null;

      document.getElementById("upload-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const fileInput = document.getElementById("file");
        const descriptionInput = document.getElementById("description");
        if (!fileInput.files.length) return;
        statusEl.classList.remove("hidden");
        statusEl.textContent = "Uploading...";
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("description", descriptionInput.value);
        try {
          const resp = await fetch("/api/upload", { method: "POST", body: formData });
          if (!resp.ok) throw new Error(await resp.text());
          const data = await resp.json();
          statusEl.textContent = "Upload complete.";
          uploadSummary.classList.remove("hidden");
          uploadSummary.innerHTML = `<strong>${data.original}</strong><br/>Parts: ${data.summary.parts}, Sheet: ${JSON.stringify(data.summary.setups || [])}`;
          await refreshFiles();
        } catch (err) {
          statusEl.textContent = `Error: ${err.message}`;
        }
      });

      document.getElementById("refresh").addEventListener("click", refreshFiles);

      async function refreshFiles() {
        filesTableBody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
        const resp = await fetch("/api/files");
        const data = await resp.json();
        filesTableBody.innerHTML = "";
        if (!data.length) {
          filesTableBody.innerHTML = "<tr><td colspan='6'>No files uploaded</td></tr>";
          return;
        }
        data.forEach((item) => {
          const row = document.createElement("tr");
          const setup = item.summary?.setups?.[0];
          row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.description || ""}</td>
            <td>${item.summary?.parts ?? "?"}</td>
            <td>${setup ? setup.sheetX + " x " + setup.sheetY : "?"}</td>
            <td>${item.paths?.original ? `<a href=\"/nas/${item.paths.original.split('/').pop()}\">file</a>` : ""}</td>
            <td><button data-id=\"${item.id}\">Extract</button></td>
          `;
          row.querySelector("button").addEventListener("click", () => openExtract(item));
          filesTableBody.appendChild(row);
        });
      }

      function openExtract(item) {
        selectedFileId = item.id;
        extractFileEl.textContent = `File: ${item.originalName || item.paths?.original}`;
        extractCard.classList.remove("hidden");
        extractStatus.textContent = "";
        extractLink.classList.add("hidden");
      }

      document.getElementById("extract-btn").addEventListener("click", async () => {
        if (!selectedFileId) return;
        const partInput = document.getElementById("part-id");
        extractStatus.textContent = "Extracting...";
        extractLink.classList.add("hidden");
        try {
          const resp = await fetch(`/api/files/${selectedFileId}/extract-part`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ partId: partInput.value }),
          });
          if (!resp.ok) throw new Error(await resp.text());
          const data = await resp.json();
          extractStatus.textContent = "Extraction complete";
          extractLink.classList.remove("hidden");
          extractLink.innerHTML = `Download: <a href=\"${data.downloadUrl || "#"}\">${data.file}</a>`;
        } catch (err) {
          extractStatus.textContent = `Error: ${err.message}`;
        }
      });

      refreshFiles();
    </script>
  </body>
</html>
