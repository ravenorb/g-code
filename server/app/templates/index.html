<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HK Parser Upload</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f8fafc;
        color: #0f172a;
      }
      h1,
      h2 {
        margin-bottom: 0.5rem;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
      }
      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background: #f1f5f9;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.35rem;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #fff;
      }
      .badge.error {
        background: #ef4444;
      }
      .badge.warning {
        background: #f59e0b;
      }
      .hidden {
        display: none;
      }
      .sheet-canvas {
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        background: #ffffff;
        margin-top: 0.5rem;
      }
      .code-box {
        background: #0f172a;
        color: #e2e8f0;
        padding: 0.75rem;
        border-radius: 6px;
        overflow-y: auto;
        max-height: 360px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <h1>HK Parser Upload</h1>
    <div class="card">
      <form id="upload-form">
        <label for="file">Select G-code file:</label>
        <input type="file" id="file" name="file" accept=".gcode,.txt,.mpf,.nc,.tap" required />
        <div style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
          <label for="description">Description:</label><br />
          <textarea id="description" name="description" rows="3" style="width: 100%;" placeholder="Describe the file contents"></textarea>
        </div>
        <button type="submit">Upload & Validate</button>
      </form>
      <p id="status" class="hidden"></p>
    </div>

    <div class="card hidden" id="results-card">
      <h2>Diagnostics</h2>
      <p id="summary"></p>
      <p id="storage"></p>
      <table id="diagnostics-table">
        <thead>
          <tr>
            <th>Severity</th>
            <th>Message</th>
            <th>Line</th>
            <th>Code</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>Original File Code</h2>
      <pre id="raw-code" class="code-box"></pre>

      <h2>Sheet Layout</h2>
      <p id="sheet-info" class="hidden"></p>
      <canvas id="sheet-canvas" class="sheet-canvas" width="720" height="420"></canvas>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const statusEl = document.getElementById("status");
      const resultsCard = document.getElementById("results-card");
      const summaryEl = document.getElementById("summary");
      const storageEl = document.getElementById("storage");
      const diagnosticsBody = document.querySelector("#diagnostics-table tbody");
      const rawCode = document.getElementById("raw-code");
      const sheetInfo = document.getElementById("sheet-info");
      const sheetCanvas = document.getElementById("sheet-canvas");
      let lastJobId = null;
      let lastJob = null;
      let sheetHotspots = [];

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const fileInput = document.getElementById("file");
        if (!fileInput.files.length) return;

        statusEl.classList.remove("hidden");
        statusEl.textContent = "Uploading and validating...";
        resultsCard.classList.add("hidden");
        diagnosticsBody.innerHTML = "";
        rawCode.textContent = "";
        sheetHotspots = [];
        lastJobId = null;

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("description", document.getElementById("description").value);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const detail = await response.text();
            throw new Error(detail || "Validation failed");
          }

          const data = await response.json();
          lastJob = data;
          lastJobId = data.job_id;
          renderSummary(data);
          renderDiagnostics(data.diagnostics);
          renderRawCode(data.raw_program || []);
          renderSheet(data.setup, data.parts);

          statusEl.textContent = "Validation completed.";
          resultsCard.classList.remove("hidden");
        } catch (err) {
          statusEl.textContent = `Error: ${err.message}`;
        }
      });

      function renderSummary(data) {
        summaryEl.textContent = `Job: ${data.job_id} — Errors: ${data.summary.errors}, Warnings: ${data.summary.warnings}, Lines: ${data.summary.lines}`;
      }

      function renderStorage(data) {
        const storageBits = [];
        if (data.stored_path) storageBits.push(`Stored: ${data.stored_path}`);
        if (data.meta_path) storageBits.push(`Meta: ${data.meta_path}`);
        if (data.uploaded_at) storageBits.push(`Uploaded: ${data.uploaded_at}`);
        storageEl.textContent = storageBits.join(" | ");
      }

      function renderDiagnostics(diagnostics) {
        diagnosticsBody.innerHTML = "";
        if (!diagnostics.length) {
          diagnosticsBody.innerHTML = `<tr><td colspan="4">No diagnostics</td></tr>`;
          return;
        }
        diagnostics.forEach((diag) => {
          const row = document.createElement("tr");
          const badge = `<span class="badge ${diag.severity}">${diag.severity}</span>`;
          row.innerHTML = `
            <td>${badge}</td>
            <td>${diag.message}</td>
            <td>${diag.line ?? ""}</td>
            <td>${diag.code ?? ""}</td>
          `;
          diagnosticsBody.appendChild(row);
        });
      }

      function renderRawCode(lines) {
        if (!lines.length) {
          rawCode.textContent = "No program lines available.";
          return;
        }
        rawCode.textContent = lines.join("\n");
      }

      function renderSheet(setup, parts) {
        const ctx = sheetCanvas.getContext("2d");
        ctx.clearRect(0, 0, sheetCanvas.width, sheetCanvas.height);
        sheetInfo.classList.add("hidden");
        sheetHotspots = [];
        sheetCanvas.style.cursor = parts.length ? "pointer" : "default";

        if (!setup || !setup.sheetX || !setup.sheetY) {
          sheetInfo.textContent = "No HKINI sheet size found for this file.";
          sheetInfo.classList.remove("hidden");
          return;
        }

        const padding = 24;
        const sheetWidth = setup.sheetX;
        const sheetHeight = setup.sheetY;
        const scale = Math.min(
          (sheetCanvas.width - padding * 2) / sheetWidth,
          (sheetCanvas.height - padding * 2) / sheetHeight
        );
        const originX = padding;
        const originY = padding;
        const drawWidth = sheetWidth * scale;
        const drawHeight = sheetHeight * scale;

        ctx.strokeStyle = "#1e293b";
        ctx.lineWidth = 2;
        ctx.strokeRect(originX, originY, drawWidth, drawHeight);

        const palette = ["#2563eb", "#16a34a", "#f97316", "#8b5cf6", "#0ea5e9"];
        ctx.font = "12px Arial";
        parts.forEach((part, index) => {
          const color = palette[index % palette.length];
          const contours = part.plot_points || [];
          let minX = null;
          let minY = null;
          let maxX = null;
          let maxY = null;

          if (contours.length) {
            contours.flat().forEach((point) => {
              const x = (part.anchor_x ?? 0) + point[0];
              const y = (part.anchor_y ?? 0) + point[1];
              minX = minX === null ? x : Math.min(minX, x);
              minY = minY === null ? y : Math.min(minY, y);
              maxX = maxX === null ? x : Math.max(maxX, x);
              maxY = maxY === null ? y : Math.max(maxY, y);
            });
          }

          if (minX === null || minY === null || maxX === null || maxY === null) {
            if (part.anchor_x == null || part.anchor_y == null) {
              return;
            }
            minX = part.anchor_x - 5;
            maxX = part.anchor_x + 5;
            minY = part.anchor_y - 5;
            maxY = part.anchor_y + 5;
          }

          let boxX = originX + minX * scale;
          let boxY = originY + (sheetHeight - maxY) * scale;
          let boxW = (maxX - minX) * scale;
          let boxH = (maxY - minY) * scale;
          const minBoxSize = 12;
          if (boxW < minBoxSize) {
            boxX -= (minBoxSize - boxW) / 2;
            boxW = minBoxSize;
          }
          if (boxH < minBoxSize) {
            boxY -= (minBoxSize - boxH) / 2;
            boxH = minBoxSize;
          }

          ctx.strokeStyle = color;
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6, 4]);
          ctx.strokeRect(boxX, boxY, boxW, boxH);
          ctx.setLineDash([]);

          ctx.fillStyle = color;
          ctx.fillText(`P${part.part_number}`, boxX + 4, boxY + 14);

          sheetHotspots.push({
            x: boxX,
            y: boxY,
            width: boxW,
            height: boxH,
            url: `/jobs/${lastJobId}/parts/${part.part_number}/view`,
          });
        });

        sheetInfo.textContent = `Sheet: ${sheetWidth} × ${sheetHeight} — Click a part to open.`;
        sheetInfo.classList.remove("hidden");
      }

      sheetCanvas.addEventListener("click", (event) => {
        if (!sheetHotspots.length) return;
        const rect = sheetCanvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const hit = sheetHotspots.find(
          (spot) => x >= spot.x && x <= spot.x + spot.width && y >= spot.y && y <= spot.y + spot.height
        );
        if (hit) {
          window.location.href = hit.url;
        }
      });
    </script>
  </body>
</html>
